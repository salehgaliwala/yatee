angular.module("ui.sortable",[]).value("uiSortableConfig",{items:"> [ng-repeat],> [data-ng-repeat],> [x-ng-repeat]"}).directive("uiSortable",["uiSortableConfig","$timeout","$log",function(h,y,C){return{require:"?ngModel",scope:{ngModel:"=",uiSortable:"="},link:function(a,u,e,i){var s;function n(e,t){var n=t&&"function"==typeof t;return e&&"function"==typeof e&&n?function(){e.apply(this,arguments),t.apply(this,arguments)}:n?t:e}function r(e){var t=e.data("ui-sortable");return t&&"object"==typeof t&&"ui-sortable"===t.widgetFullName?t:null}function c(e,t){return p[e]?("stop"===e&&(t=n(t=n(t,function(){a.$apply()}),o)),t=n(p[e],t)):g[e]&&(t=g[e](t)),t||("items"===e?t=h.items:"ui-model-items"===e&&(t=h.items)),t}function l(o,e,n){angular.forEach(p,function i(e,t){t in m||(m[t]=null)});var l,r=null;e&&angular.forEach(e,function(e,t){if(!(o&&t in o)){if(t in b)return void(m[t]="ui-floating"===t?"auto":c(t,undefined));l||(l=angular.element.ui.sortable().options);var n=l[t];n=c(t,n),r||(r={}),r[t]=n,m[t]=n}});return angular.forEach(o,function(e,t){if(t in b)return"ui-floating"!==t||!1!==e&&!0!==e||!n||(n.floating=e),void(m[t]=c(t,e));e=c(t,e),r||(r={}),r[t]=e,m[t]=e}),r}function d(e,t,n){var o=null;return function l(e,t){var n=e.sortable("option","helper");return"clone"===n||"function"==typeof n&&t.item.sortable.isCustomHelperUsed()}(e,t)&&"parent"===e.sortable("option","appendTo")&&(o=n.last()),o}function o(e,t){t.item.sortable._destroy()}function f(e){return e.parent().find(m["ui-model-items"]).index(e)}var m={},b={"ui-floating":undefined,"ui-model-items":h.items},p={receive:null,remove:null,start:null,stop:null,update:null},g={helper:null};function t(){a.$watchCollection("ngModel",function(){y(function(){r(u)&&u.sortable("refresh")},0,!1)}),p.start=function(e,n){if("auto"===m["ui-floating"]){var t=n.item.siblings();r(angular.element(e.target)).floating=function l(e){return/left|right/.test(e.css("float"))||/inline|table-cell/.test(e.css("display"))}(t)}var o=f(n.item);n.item.sortable={model:i.$modelValue[o],index:o,source:n.item.parent(),sourceModel:i.$modelValue,cancel:function(){n.item.sortable._isCanceled=!0},isCanceled:function(){return n.item.sortable._isCanceled},isCustomHelperUsed:function(){return!!n.item.sortable._isCustomHelperUsed},_isCanceled:!1,_isCustomHelperUsed:n.item.sortable._isCustomHelperUsed,_destroy:function(){angular.forEach(n.item.sortable,function(e,t){n.item.sortable[t]=undefined})}}},p.activate=function(e,t){s=u.contents();var n=function r(e){var t=e.sortable("option","placeholder");if(t&&t.element&&"function"==typeof t.element){var n=t.element();return n=angular.element(n)}return null}(u);if(n&&n.length){var o=function i(e,t){var n=m["ui-model-items"].replace(/[^,]*>/g,"");return e.find('[class="'+t.attr("class")+'"]:not('+n+")")}(u,n);s=s.not(o)}var l=t.item.sortable._connectedSortables||[];l.push({element:u,scope:a}),t.item.sortable._connectedSortables=l},p.update=function(e,t){if(!t.item.sortable.received){t.item.sortable.dropindex=f(t.item);var n=t.item.parent();t.item.sortable.droptarget=n;var o=function r(e,t){for(var n=null,o=0;o<e.length;o++){var l=e[o];if(l.element[0]===t[0]){n=l.scope;break}}return n}(t.item.sortable._connectedSortables,n);t.item.sortable.droptargetModel=o.ngModel,u.sortable("cancel")}var l=!t.item.sortable.received&&d(u,t,s);l&&l.length&&(s=s.not(l)),s.appendTo(u),t.item.sortable.received&&(s=null),t.item.sortable.received&&!t.item.sortable.isCanceled()&&a.$apply(function(){i.$modelValue.splice(t.item.sortable.dropindex,0,t.item.sortable.moved)})},p.stop=function(e,t){if(!t.item.sortable.received&&"dropindex"in t.item.sortable&&!t.item.sortable.isCanceled())a.$apply(function(){i.$modelValue.splice(t.item.sortable.dropindex,0,i.$modelValue.splice(t.item.sortable.index,1)[0])});else if((!("dropindex"in t.item.sortable)||t.item.sortable.isCanceled())&&!angular.equals(u.contents(),s)){var n=d(u,t,s);n&&n.length&&(s=s.not(n)),s.appendTo(u)}s=null},p.receive=function(e,t){t.item.sortable.received=!0},p.remove=function(e,t){"dropindex"in t.item.sortable||(u.sortable("cancel"),t.item.sortable.cancel()),t.item.sortable.isCanceled()||a.$apply(function(){t.item.sortable.moved=i.$modelValue.splice(t.item.sortable.index,1)[0]})},g.helper=function(r){return r&&"function"==typeof r?function(e,n){var t=n.sortable,o=f(n);n.sortable={model:i.$modelValue[o],index:o,source:n.parent(),sourceModel:i.$modelValue,_restore:function(){angular.forEach(n.sortable,function(e,t){n.sortable[t]=undefined}),n.sortable=t}};var l=r.apply(this,arguments);return n.sortable._restore(),n.sortable._isCustomHelperUsed=n!==l,l}:r},a.$watchCollection("uiSortable",function(e,t){var n=r(u);if(n){var o=l(e,t,n);o&&u.sortable("option",o)}},!0),l(m)}function v(){return(!a.uiSortable||!a.uiSortable.disabled)&&(function e(){i?t():C.info("ui.sortable: ngModel not provided!",u),u.sortable(m)}(),v.cancelWatcher(),v.cancelWatcher=angular.noop,!0)}angular.extend(m,b,h,a.uiSortable),angular.element.fn&&angular.element.fn.jquery?(v.cancelWatcher=angular.noop,v()||(v.cancelWatcher=a.$watch("uiSortable.disabled",v))):C.error("ui.sortable: jQuery should be included before AngularJS!")}}}]);